<!DOCTYPE html>
<html lang='zh-CN'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>è¾‰å…‰ç®¡æ—¶é’Ÿæ§åˆ¶é¢æ¿</title>
    <style>
        :root {
            --primary-color: #2196F3;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .header .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 500;
            color: #666;
        }
        
        .info-value {
            font-weight: 600;
            color: var(--text-color);
        }
        
        .progress-bar {
            width: 100px;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--success-color);
            transition: width 0.3s;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #666;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .password-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .password-wrapper .info-value {
            flex: 1;
            margin-right: 30px;
        }
        
        .password-toggle {
            position: absolute;
            right: 5px;
            cursor: pointer;
            color: #666;
            user-select: none;
            font-size: 16px;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* æ—¶åŒºé€‰æ‹©å™¨æ ·å¼ */
        #timezone-select {
            font-family: monospace;
            text-align: right;
        }
        
        #timezone-select option {
            text-align: right;
        }
        

        
        .network-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            margin: 2px 0;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .network-item:hover {
            background-color: var(--hover-color);
        }
        
        .network-item.selected {
            background-color: var(--primary-color);
            color: white;
        }
        
        .network-ssid {
            font-weight: 500;
        }
        
        .network-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #666;
        }
        
        .network-item.selected .network-info {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .signal-strength {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .signal-bar {
            width: 3px;
            background-color: #ddd;
            border-radius: 1px;
        }
        
        .signal-bar.active {
            background-color: #4CAF50;
        }
        
        .security-icon {
            font-size: 14px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: #1976D2;
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background: #45a049;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 14px;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        input[type="number"]:invalid {
            border-color: var(--danger-color);
        }
        
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 14px;
        }
        
        select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class='container'>
        <div class='header'>
            <h1>è¾‰å…‰ç®¡æ—¶é’Ÿæ§åˆ¶é¢æ¿</h1>
            <div class='status'>
                <div class='status-dot'></div>
                <span id='system-status'>ç³»ç»Ÿè¿è¡Œä¸­</span>
            </div>
        </div>
        
        <div id='alert' class='alert'></div>
        
        <div class='grid'>
            <!-- æ—¶é—´ä¿¡æ¯ -->
            <div class='card'>
                <h2>â° æ—¶é—´ä¿¡æ¯</h2>
                <div class='info-row'>
                    <span class='info-label'>å½“å‰RTCæ—¶é—´</span>
                    <span class='info-value' id='rtc-time'>--:--:--</span>
                </div>
                <div class='info-row'>
                    <span class='info-label'>ä¸Šæ¬¡æ ¡å‡†æ—¶é—´</span>
                    <span class='info-value' id='last-calibration'>ä»æœªæ ¡å‡†</span>
                </div>
                <div class='info-row'>
                    <span class='info-label'>NTPæœåŠ¡å™¨</span>
                    <span class='info-value' id='ntp-server'>ntp.ntsc.ac.cn</span>
                </div>
                <div class='info-row'>
                    <span class='info-label'>è¿è¡Œæ—¶é—´</span>
                    <span class='info-value' id='runtime'>0000H00M</span>
                </div>
                <div class='info-row'>
                    <span class='info-label'>å½“å‰æ—¶åŒº</span>
                    <span class='info-value' id='timezone'>Asia/Shanghai (+8)</span>
                </div>
                <div class='info-row'>
                    <span class='info-label'>BMP580æ¸©åº¦</span>
                    <span class='info-value' id='bmp580-temperature'>--Â°C</span>
                </div>
                <div class='info-row'>
                    <span class='info-label'>BMP580æ°”å‹</span>
                    <span class='info-value' id='bmp580-pressure'>--hPa</span>
                </div>
                <div class='info-row'>
                    <span class='info-label'>AHT20æ¸©åº¦</span>
                    <span class='info-value' id='aht20-temperature'>--Â°C</span>
                </div>
                <div class='info-row'>
                    <span class='info-label'>AHT20æ¹¿åº¦</span>
                    <span class='info-value' id='aht20-humidity'>--%</span>
                </div>
            </div>
            
            <!-- ç³»ç»ŸçŠ¶æ€ -->
            <div class='card'>
                <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
                <div class='info-row'>
                    <span class='info-label'>ç”µé‡</span>
                    <div style='display: flex; align-items: center; gap: 10px;'>
                        <div class='progress-bar'>
                            <div class='progress-fill' id='battery-progress' style='width: 0%'></div>
                        </div>
                        <span class='info-value' id='battery-percent'>0%</span>
                    </div>
                </div>
                <div class='info-row'>
                    <span class='info-label'>ç”µæ± ç”µå‹</span>
                    <span class='info-value' id='battery-voltage'>0.0V</span>
                </div>
                <div class='info-row'>
                    <span class='info-label'>ç”µæ± ç”µæµ</span>
                    <span class='info-value' id='battery-current'>0mA</span>
                </div>
                <div class='info-row'>
                    <span class='info-label'>CPUä½¿ç”¨ç‡</span>
                    <div style='display: flex; align-items: center; gap: 10px;'>
                        <div class='progress-bar'>
                            <div class='progress-fill' id='cpu-progress' style='width: 0%'></div>
                        </div>
                        <span class='info-value' id='cpu-usage'>0%</span>
                    </div>
                </div>
                <div class='info-row'>
                    <span class='info-label'>å†…å­˜ä½¿ç”¨ç‡</span>
                    <div style='display: flex; align-items: center; gap: 10px;'>
                        <div class='progress-bar'>
                            <div class='progress-fill' id='memory-progress' style='width: 0%'></div>
                        </div>
                        <span class='info-value' id='memory-usage'>0%</span>
                    </div>
                </div>
                <div class='info-row'>
                    <span class='info-label'>Flashä½¿ç”¨ç‡</span>
                    <div style='display: flex; align-items: center; gap: 10px;'>
                        <div class='progress-bar'>
                            <div class='progress-fill' id='flash-progress' style='width: 0%'></div>
                        </div>
                        <span class='info-value' id='flash-usage'>0%</span>
                    </div>
                </div>
                <div class='info-row'>
                    <span class='info-label'>å½“å‰æ˜¾ç¤º</span>
                    <span class='info-value' id='current-display-content'>æ—¶é—´</span>
                </div>
                <div class='info-row'>
                    <span class='info-label'>åˆ·æ–°ç‡</span>
                    <span class='info-value' id='current-refresh-rate'>1Hz (1æ¬¡/ç§’)</span>
                </div>
            </div>
            
            <!-- ç½‘ç»œä¿¡æ¯ -->
            <div class='card'>
                <h2>ğŸŒ ç½‘ç»œä¿¡æ¯</h2>
                <div class='info-row'>
                    <span class='info-label'>APåç§°</span>
                    <span class='info-value' id='ap-ssid'>NixieClock</span>
                </div>
                <div class='info-row'>
                    <span class='info-label'>APå¯†ç </span>
                    <div class='password-wrapper'>
                        <span class='info-value' id='ap-password' data-hidden='true'>********</span>
                        <span class='password-toggle' onclick='togglePassword("ap-password")'>ğŸ‘ï¸</span>
                    </div>
                </div>
                <div class='info-row'>
                    <span class='info-label'>AP IPåœ°å€</span>
                    <span class='info-value' id='ap-ip'>192.168.4.1</span>
                </div>
                <div class='info-row'>
                    <span class='info-label'>APç½‘å…³</span>
                    <span class='info-value' id='ap-gateway'>192.168.4.1</span>
                </div>
                <div class='info-row'>
                    <span class='info-label'>WiFiè¿æ¥</span>
                    <span class='info-value' id='wifi-ssid'>æœªè¿æ¥</span>
                </div>
                <div class='info-row'>
                    <span class='info-label'>IPåœ°å€</span>
                    <span class='info-value' id='sta-ip'>--</span>
                </div>
            </div>
            
            <!-- WiFié…ç½® -->
            <div class='card'>
                <h2>ğŸ“¡ WiFié…ç½®</h2>
                
                <div class='form-group'>
                    <label style='display: flex; align-items: center; gap: 10px;'>
                        <input type='checkbox' id='wifi-enable' checked>
                        <span>å¯ç”¨WiFiå®¢æˆ·ç«¯æ¨¡å¼</span>
                    </label>
                </div>
                
                <div id='wifi-config-content'>
                    <!-- ç½‘ç»œæ‰«æéƒ¨åˆ† -->
                    <div class='form-group'>
                        <label>æ‰«æé™„è¿‘ç½‘ç»œ</label>
                        <button type='button' class='btn btn-primary' onclick='scanWifiNetworks()' id='scan-btn'>ğŸ” æ‰«æç½‘ç»œ</button>
                    </div>
                    
                    <!-- ç½‘ç»œåˆ—è¡¨ - å§‹ç»ˆæ˜¾ç¤º -->
                    <div id='wifi-networks' style='margin-bottom: 15px;'>
                        <label>ç½‘ç»œåˆ—è¡¨</label>
                        <div id='network-list' style='height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 5px; padding: 5px; background-color: var(--card-bg);'>
                            <div style="text-align: center; padding: 20px; color: #666;">ç‚¹å‡»"æ‰«æç½‘ç»œ"æŸ¥çœ‹é™„è¿‘WiFi</div>
                        </div>
                    </div>
                    
                    <form id='wifi-form'>
                        <div class='form-group'>
                            <label>WiFiåç§°</label>
                            <input type='text' id='wifi-ssid-input' placeholder='è¾“å…¥WiFiåç§°æˆ–ä»ä¸Šæ–¹åˆ—è¡¨é€‰æ‹©'>
                        </div>
                        <div class='form-group'>
                            <label>WiFiå¯†ç </label>
                            <input type='password' id='wifi-password-input' placeholder='è¾“å…¥WiFiå¯†ç '>
                        </div>
                        <button type='submit' class='btn btn-primary'>è¿æ¥WiFi</button>
                    </form>
                </div>
            </div>
            
            <!-- APé…ç½® -->
            <div class='card'>
                <h2>ğŸ”§ APé…ç½®</h2>
                
                <div class='form-group'>
                    <label style='display: flex; align-items: center; gap: 10px;'>
                        <input type='checkbox' id='ap-enable' checked>
                        <span>å¯ç”¨APçƒ­ç‚¹æ¨¡å¼</span>
                    </label>
                </div>
                
                <div id='ap-config-content'>
                    <form id='ap-form'>
                        <div class='form-group'>
                            <label>APåç§°</label>
                            <input type='text' id='ap-ssid-input' placeholder='è¾“å…¥APåç§°'>
                        </div>
                        <div class='form-group'>
                            <label>APå¯†ç </label>
                            <input type='password' id='ap-password-input' placeholder='è¾“å…¥APå¯†ç (è‡³å°‘8ä½)'>
                        </div>
                        <div class='form-group'>
                            <label>AP IPåœ°å€</label>
                            <input type='text' id='ap-ip-input' placeholder='ä¾‹å¦‚: 192.168.4.1' value='192.168.4.1'>
                        </div>
                        <div class='form-group'>
                            <label>é»˜è®¤ç½‘å…³</label>
                            <input type='text' id='ap-gateway-input' placeholder='ä¾‹å¦‚: 192.168.4.1' value='192.168.4.1'>
                        </div>
                        <button type='submit' class='btn btn-primary'>æ›´æ–°APè®¾ç½®</button>
                    </form>
                </div>
            </div>
            
            <!-- æ—¶é—´é…ç½® -->
            <div class='card'>
                <h2>ğŸ• æ—¶é—´é…ç½®</h2>
                <form id='time-form'>
                    <div class='form-group'>
                        <label>NTPæœåŠ¡å™¨</label>
                        <input type='text' id='ntp-server-input' value='ntp.ntsc.ac.cn'>
                    </div>
                    
                    <div class='form-group'>
                        <label style='display: flex; align-items: center; gap: 10px;'>
                            <input type='checkbox' id='ntp-auto-sync' checked>
                            <span>å¯ç”¨NTPè‡ªåŠ¨æ ¡å‡†</span>
                        </label>
                    </div>
                    
                    <div class='form-group' id='ntp-interval-group'>
                        <label>æ ¡å‡†é—´éš” (åˆ†é’Ÿ)</label>
                        <div style='display: flex; gap: 10px; align-items: center;'>
                            <input type='number' id='ntp-interval-input' value='60' min='1' max='1440' placeholder='è¾“å…¥åˆ†é’Ÿæ•°' style='flex: 1;'>
                            <span style='color: #666; font-size: 12px; white-space: nowrap;'>1-1440åˆ†é’Ÿ</span>
                        </div>
                    </div>
                    
                    <button type='button' class='btn btn-secondary' onclick='saveNTPSettings()'>ä¿å­˜NTPè®¾ç½®</button>
                    
                    <button type='button' class='btn btn-primary' onclick='syncNTP()'>ç«‹å³åŒæ­¥NTPæ—¶é—´</button>
                    
                    <hr style='margin: 20px 0;'>
                    
                    <div class='form-group'>
                        <label>æ—¶åŒºè®¾ç½®</label>
                        <select id='timezone-select' onchange='updateTimezoneOffset()'>
                            <!-- æŒ‰æ—¶é—´åç§»æ’åºï¼Œä»ä¸œåˆ°è¥¿ -->
                            <option value='39600' data-name='Pacific/Auckland'>å¥¥å…‹å…° (UTC+12)</option>
                            <option value='36000' data-name='Australia/Sydney'>æ‚‰å°¼ (UTC+10)</option>
                            <option value='32400' data-name='Asia/Tokyo'>ä¸œäº¬ (UTC+9)</option>
                            <option value='32400' data-name='Australia/Brisbane'>å¸ƒé‡Œæ–¯ç­ (UTC+9)</option>
                            <option value='28800' data-name='Asia/Shanghai'>åŒ—äº¬ (UTC+8)</option>
                            <option value='28800' data-name='Australia/Perth'>ç€æ–¯ (UTC+8)</option>
                            <option value='25200' data-name='Asia/Bangkok'>æ›¼è°· (UTC+7)</option>
                            <option value='21600' data-name='Asia/Dhaka'>è¾¾å¡ (UTC+6)</option>
                            <option value='19800' data-name='Asia/Kolkata'>å°åº¦ (UTC+5:30)</option>
                            <option value='16200' data-name='Asia/Kolkata'>å°åº¦ (UTC+4:30)</option>
                            <option value='14400' data-name='Asia/Dubai'>è¿ªæ‹œ (UTC+4)</option>
                            <option value='12600' data-name='Asia/Tehran'>å¾·é»‘å…° (UTC+3:30)</option>
                            <option value='10800' data-name='Europe/Moscow'>è«æ–¯ç§‘ (UTC+3)</option>
                            <option value='7200' data-name='Europe/Paris'>å·´é» (UTC+2)</option>
                            <option value='7200' data-name='Europe/Rome'>ç½—é©¬ (UTC+2)</option>
                            <option value='7200' data-name='Europe/Madrid'>é©¬å¾·é‡Œ (UTC+2)</option>
                            <option value='7200' data-name='Europe/Berlin'>æŸæ— (UTC+2)</option>
                            <option value='7200' data-name='Africa/Cairo'>å¼€ç½— (UTC+2)</option>
                            <option value='3600' data-name='Europe/Amsterdam'>é˜¿å§†æ–¯ç‰¹ä¸¹ (UTC+1)</option>
                            <option value='3600' data-name='Europe/Brussels'>å¸ƒé²å¡å°” (UTC+1)</option>
                            <option value='3600' data-name='Europe/London'>ä¼¦æ•¦ (UTC+1)</option>
                            <option value='3600' data-name='Africa/Lagos'>æ‹‰å„æ–¯ (UTC+1)</option>
                            <option value='0' data-name='UTC'>UTC (UTC+0)</option>
                            <option value='0' data-name='Europe/Dublin'>éƒ½æŸæ— (UTC+0)</option>
                            <option value='0' data-name='Africa/Casablanca'>å¡è¨å¸ƒå…°å¡ (UTC+0)</option>
                            <option value='-3600' data-name='Atlantic/Azores'>äºšé€Ÿå°” (UTC-1)</option>
                            <option value='-10800' data-name='America/Sao_Paulo'>åœ£ä¿ç½— (UTC-3)</option>
                            <option value='-14400' data-name='America/Santiago'>åœ£åœ°äºšå“¥ (UTC-4)</option>
                            <option value='-18000' data-name='America/New_York'>çº½çº¦ (UTC-5)</option>
                            <option value='-18000' data-name='America/Toronto'>å¤šä¼¦å¤š (UTC-5)</option>
                            <option value='-18000' data-name='America/Lima'>åˆ©é©¬ (UTC-5)</option>
                            <option value='-21600' data-name='America/Chicago'>èŠåŠ å“¥ (UTC-6)</option>
                            <option value='-25200' data-name='America/Phoenix'>å‡¤å‡°åŸ (UTC-7)</option>
                            <option value='-28800' data-name='America/Denver'>ä¸¹ä½› (UTC-8)</option>
                            <option value='-28800' data-name='America/Los_Angeles'>æ´›æ‰çŸ¶ (UTC-8)</option>
                            <option value='-28800' data-name='America/Vancouver'>æ¸©å“¥å (UTC-8)</option>
                            <option value='-32400' data-name='America/Anchorage'>å®‰å…‹é›·å¥‡ (UTC-9)</option>
                            <option value='-36000' data-name='Pacific/Honolulu'>æª€é¦™å±± (UTC-10)</option>
                        </select>
                    </div>
                    <button type='button' class='btn btn-secondary' onclick='saveTimezoneSettings()'>ä¿å­˜æ—¶åŒºè®¾ç½®</button>
                    
                    <hr style='margin: 20px 0;'>
                    
                    <div class='form-group'>
                        <label>æ‰‹åŠ¨è®¾ç½®æ—¶é—´</label>
                        <input type='datetime-local' id='manual-time-input'>
                    </div>
                    <div class='btn-group' style='gap: 10px;'>
                        <button type='button' class='btn btn-primary' onclick='setManualTime()'>è®¾ç½®æ—¶é—´</button>
                        <button type='button' class='btn btn-secondary' onclick='setBrowserTime()'>ä½¿ç”¨æµè§ˆå™¨æ—¶é—´</button>
                    </div>
                </form>
            </div>
            
            <!-- æ˜¾ç¤ºå†…å®¹é€‰æ‹© -->
            <div class='card'>
                <h2>ğŸ“º æ˜¾ç¤ºå†…å®¹é€‰æ‹©</h2>
                <div class='form-group'>
                    <label>é€‰æ‹©æ˜¾ç¤ºå†…å®¹</label>
                    <select id='display-content-select' onchange='updateDisplayContent()'>
                        <option value='time'>æ—¶é—´</option>
                        <option value='bmp580_temperature'>BMP580æ¸©åº¦</option>
                        <option value='bmp580_pressure'>BMP580æ°”å‹</option>
                        <option value='aht20_temperature'>AHT20æ¸©åº¦</option>
                        <option value='aht20_humidity'>AHT20æ¹¿åº¦</option>
                        <option value='custom'>è‡ªå®šä¹‰å†…å®¹</option>
                    </select>
                </div>
                <div class='form-group' id='custom-content-group' style='display: none;'>
                    <label>è‡ªå®šä¹‰æ˜¾ç¤ºå†…å®¹</label>
                    <input type='text' id='custom-content-input' placeholder='è¾“å…¥è¦æ˜¾ç¤ºçš„å†…å®¹' maxlength='8'>
                </div>
                <div class='form-group'>
                    <label>åˆ·æ–°ç‡è®¾ç½®</label>
                    <select id='refresh-rate-select' onchange='updateRefreshRate()'>
                        <option value='minute'>åˆ†è·³å˜ (1æ¬¡/åˆ†é’Ÿ)</option>
                        <option value='1' selected>1Hz (1æ¬¡/ç§’)</option>
                        <option value='2'>2Hz (2æ¬¡/ç§’)</option>
                        <option value='5'>5Hz (5æ¬¡/ç§’)</option>
                        <option value='10'>10Hz (10æ¬¡/ç§’)</option>
                    </select>
                </div>
                <button type='button' class='btn btn-primary' onclick='applyDisplayContent()'>åº”ç”¨æ˜¾ç¤ºè®¾ç½®</button>
            </div>
            
            <!-- ç³»ç»Ÿæ“ä½œ -->
            <div class='card'>
                <h2>âš™ï¸ ç³»ç»Ÿæ“ä½œ</h2>
                <div class='btn-group'>
                    <button class='btn btn-success' onclick='showRebootModal()'>ğŸ”„ é‡å¯ç³»ç»Ÿ</button>
                    <button class='btn btn-danger' onclick='showFactoryResetModal()'>âš ï¸ æ¢å¤å‡ºå‚è®¾ç½®</button>
                </div>
                
                <!-- ç”µæ± ç®¡ç† -->
                <div style='margin-top: 20px;'>
                    <h3>ğŸ”‹ ç”µæ± ç®¡ç†</h3>
                    <div class='btn-group' style='margin-bottom: 15px;'>
                        <button class='btn btn-warning' onclick='showResetBatteryModal()'>ğŸ”„ å¤ä½ç”µé‡è®¡</button>
                    </div>
                    
                    <div class='form-group'>
                        <label for='battery-capacity'>ç”µæ± å®¹é‡è®¾ç½® (mAh):</label>
                        <div style='display: flex; gap: 10px; align-items: center;'>
                            <input type='number' id='battery-capacity' class='form-control' placeholder='è¯·è¾“å…¥ç”µæ± å®¹é‡' min='100' max='10000' style='flex: 1;'>
                            <button class='btn btn-primary' onclick='showSetBatteryCapacityModal()'>è®¾ç½®å®¹é‡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é‡å¯ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id='reboot-modal' class='modal'>
        <div class='modal-content'>
            <div class='modal-header'>
                <h3>ç¡®è®¤é‡å¯</h3>
                <p>æ‚¨ç¡®å®šè¦é‡å¯ç³»ç»Ÿå—ï¼Ÿ</p>
            </div>
            <div class='modal-footer'>
                <button class='btn btn-primary' onclick='hideModal("reboot-modal")'>å–æ¶ˆ</button>
                <button class='btn btn-success' onclick='confirmReboot()'>ç¡®è®¤é‡å¯</button>
            </div>
        </div>
    </div>
    
    <!-- æ¢å¤å‡ºå‚è®¾ç½®ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id='factory-reset-modal' class='modal'>
        <div class='modal-content'>
            <div class='modal-header'>
                <h3>âš ï¸ è­¦å‘Š</h3>
                <p>æ¢å¤å‡ºå‚è®¾ç½®å°†æ¸…é™¤æ‰€æœ‰é…ç½®ï¼ŒåŒ…æ‹¬ï¼š</p>
                <ul style='margin-top: 10px; padding-left: 20px;'>
                    <li>WiFié…ç½®</li>
                    <li>APè®¾ç½®</li>
                    <li>æ—¶é—´è®¾ç½®</li>
                    <li>è¿è¡Œæ—¶é—´è®°å½•</li>
                </ul>
                <p style='margin-top: 10px; color: var(--danger-color);'>æ­¤æ“ä½œä¸å¯æ¢å¤ï¼</p>
            </div>
            <div class='modal-footer'>
                <button class='btn btn-primary' onclick='hideModal("factory-reset-modal")'>å–æ¶ˆ</button>
                <button class='btn btn-danger' onclick='confirmFactoryReset()'>ç¡®è®¤æ¢å¤</button>
            </div>
        </div>
    </div>

    <!-- å¤ä½ç”µé‡è®¡ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id='reset-battery-modal' class='modal'>
        <div class='modal-content'>
            <div class='modal-header'>
                <h3>ğŸ”„ å¤ä½ç”µé‡è®¡</h3>
                <p>æ‚¨ç¡®å®šè¦å¤ä½ç”µé‡è®¡å—ï¼Ÿ</p>
                <p style='margin-top: 10px; color: var(--warning-color);'>æ­¤æ“ä½œå°†é‡ç½®ç”µæ± ç”µé‡è®¡çš„æ ¡å‡†æ•°æ®ã€‚</p>
            </div>
            <div class='modal-footer'>
                <button class='btn btn-primary' onclick='hideModal("reset-battery-modal")'>å–æ¶ˆ</button>
                <button class='btn btn-warning' onclick='confirmResetBattery()'>ç¡®è®¤å¤ä½</button>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®ç”µæ± å®¹é‡ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id='set-battery-capacity-modal' class='modal'>
        <div class='modal-content'>
            <div class='modal-header'>
                <h3>ğŸ”‹ è®¾ç½®ç”µæ± å®¹é‡</h3>
                <p>æ‚¨ç¡®å®šè¦è®¾ç½®ç”µæ± å®¹é‡ä¸º <span id='capacity-value'></span> mAh å—ï¼Ÿ</p>
                <p style='margin-top: 10px; color: var(--warning-color);'>æ­¤æ“ä½œå°†æ›´æ–°ç”µæ± ç®¡ç†èŠ¯ç‰‡çš„è®¾è®¡å®¹é‡å‚æ•°ã€‚</p>
            </div>
            <div class='modal-footer'>
                <button class='btn btn-primary' onclick='hideModal("set-battery-capacity-modal")'>å–æ¶ˆ</button>
                <button class='btn btn-primary' onclick='confirmSetBatteryCapacity()'>ç¡®è®¤è®¾ç½®</button>
            </div>
        </div>
    </div>
    
    <script>
        let systemData = {};
        let isInitialLoad = true; // æ ‡è®°æ˜¯å¦ä¸ºåˆå§‹åŠ è½½
        
        // æ˜¾ç¤º/éšè—å¯†ç 
        function togglePassword(id) {
            const elem = document.getElementById(id);
            const wrapper = elem.parentElement;
            const toggleBtn = wrapper.querySelector('.password-toggle');
            const isHidden = elem.getAttribute('data-hidden') === 'true';
            
            if (isHidden) {
                elem.textContent = systemData.ap_password || '12345678';
                elem.setAttribute('data-hidden', 'false');
                toggleBtn.textContent = 'ğŸ‘ï¸'; // æ˜¾ç¤ºå›¾æ ‡
            } else {
                elem.textContent = '********';
                elem.setAttribute('data-hidden', 'true');
                toggleBtn.textContent = 'ğŸ™ˆ'; // éšè—å›¾æ ‡
            }
        }
        

        
        // æ›´æ–°RTCæ—¶é—´æ˜¾ç¤º - ä½¿ç”¨ç³»ç»Ÿæ•°æ®ä¸­çš„RTCæ—¶é—´
        function updateRTCTime() {
            // å¦‚æœç³»ç»Ÿæ•°æ®ä¸­æœ‰RTCæ—¶é—´ï¼Œä½¿ç”¨ç³»ç»Ÿæ•°æ®
            if (systemData.current_rtc_time && systemData.current_rtc_time !== '--:--:--') {
                document.getElementById('rtc-time').textContent = systemData.current_rtc_time;
            } else {
                // å¦‚æœæ²¡æœ‰ç³»ç»Ÿæ•°æ®ï¼Œæ˜¾ç¤ºå ä½ç¬¦
                document.getElementById('rtc-time').textContent = '--:--:--';
            }
        }
        
        // å¯åŠ¨RTCæ—¶é—´æ›´æ–°
        function startSyncedTimeUpdate() {
            // ç«‹å³æ›´æ–°ä¸€æ¬¡
            updateRTCTime();
            
            // æ¯ç§’æ›´æ–°ä¸€æ¬¡RTCæ—¶é—´æ˜¾ç¤º
            setInterval(updateRTCTime, 1000);
        }
        
        // å¯åŠ¨ä¸æ—¶é—´åŒæ­¥çš„æ•°æ®åˆ·æ–°
        function startSyncedDataUpdate() {
            let lastSecond = -1;
            let lastMinute = -1;
            let currentWakeupMode = 0; // é»˜è®¤ä¸ºç§’è·³å˜æ¨¡å¼
            let customRefreshRate = '1'; // é»˜è®¤1Hz
            let customRefreshInterval = null;
            let lastCustomUpdate = 0;
            
            function syncedUpdate() {
                const now = new Date();
                const currentSecond = now.getSeconds();
                const currentMinute = now.getMinutes();
                const currentTime = now.getTime();
                
                // æ ¹æ®å”¤é†’æ¨¡å¼å’Œè‡ªå®šä¹‰åˆ·æ–°ç‡å†³å®šæ›´æ–°é¢‘ç‡
                if (currentWakeupMode === 0) {
                    // ç§’è·³å˜æ¨¡å¼ï¼šæ ¹æ®è‡ªå®šä¹‰åˆ·æ–°ç‡æ›´æ–°æ•°æ®
                    if (customRefreshRate === 'minute') {
                        // åˆ†è·³å˜
                        if (lastMinute !== -1 && lastMinute !== currentMinute) {
                            fetchData();
                            console.log('åˆ†é’Ÿè·³å˜ï¼Œæ›´æ–°æ•°æ®ï¼Œå½“å‰æ—¶é—´:', now.toLocaleTimeString());
                        }
                    } else {
                        // é«˜é¢‘ç‡åˆ·æ–° (2Hz, 5Hz, 10Hz)
                        const rate = parseInt(customRefreshRate);
                        if (rate > 1) {
                            const interval = 1000 / rate; // è®¡ç®—é—´éš”æ—¶é—´
                            if (currentTime - lastCustomUpdate >= interval) {
                                fetchData();
                                lastCustomUpdate = currentTime;
                            }
                        } else {
                            // 1Hzï¼šæ¯ç§’æ›´æ–°
                            if (lastSecond !== -1 && lastSecond !== currentSecond) {
                                fetchData();
                            }
                        }
                    }
                } else if (currentWakeupMode === 1) {
                    // åˆ†è·³å˜æ¨¡å¼ï¼šæ¯åˆ†é’Ÿæ›´æ–°æ•°æ®
                    if (lastMinute !== -1 && lastMinute !== currentMinute) {
                        fetchData();
                        console.log('åˆ†é’Ÿè·³å˜ï¼Œæ›´æ–°æ•°æ®ï¼Œå½“å‰æ—¶é—´:', now.toLocaleTimeString());
                    }
                }
                
                lastSecond = currentSecond;
                lastMinute = currentMinute;
            }
            
            // æ›´æ–°å”¤é†’æ¨¡å¼çš„å‡½æ•°
            window.updateWakeupMode = function(mode) {
                currentWakeupMode = mode;
                console.log('æ•°æ®åˆ·æ–°æ¨¡å¼å·²åˆ‡æ¢ä¸º:', mode === 0 ? 'ç§’è·³å˜' : 'åˆ†è·³å˜');
            };
            
            // æ›´æ–°è‡ªå®šä¹‰åˆ·æ–°ç‡çš„å‡½æ•°
            window.updateDataRefreshRate = function(rate) {
                customRefreshRate = rate;
                lastCustomUpdate = 0; // é‡ç½®è®¡æ—¶å™¨
                console.log('è‡ªå®šä¹‰åˆ·æ–°ç‡å·²åˆ‡æ¢ä¸º:', rate);
            };
            
            // ä½¿ç”¨é«˜é¢‘ç‡æ£€æŸ¥æ¥æ•è·ç²¾ç¡®çš„æ—¶é—´è·³å˜
            setInterval(syncedUpdate, 50); // æ¯50msæ£€æŸ¥ä¸€æ¬¡ï¼Œæ”¯æŒæ›´é«˜é¢‘ç‡
        }
        
        // æ˜¾ç¤ºæç¤ºï¼ˆä»…ç”¨äºç”¨æˆ·æ“ä½œåé¦ˆï¼Œä¸ç”¨äºç³»ç»Ÿé”™è¯¯ï¼‰
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }
        
        // æ˜¾ç¤ºç®€çŸ­çš„çŠ¶æ€æç¤ºï¼ˆä¸å½±å“å¸ƒå±€ï¼‰
        function showToast(message, type = 'info') {
            // åœ¨çŠ¶æ€æ æ˜¾ç¤ºç®€çŸ­æç¤ºï¼Œè€Œä¸æ˜¯æ˜¾ç¤ºå¤§çš„alertæ¡†
            const statusText = document.getElementById('system-status');
            const originalText = statusText.textContent;
            
            statusText.textContent = message;
            setTimeout(() => {
                // å¦‚æœè¿æ¥æ­£å¸¸ï¼Œæ¢å¤åŸå§‹çŠ¶æ€æ–‡æœ¬
                if (type !== 'error') {
                    statusText.textContent = originalText;
                }
            }, 2000);
        }
        
        // æ¨¡æ€æ¡†æ§åˆ¶
        function showRebootModal() {
            document.getElementById('reboot-modal').style.display = 'block';
        }
        
        function showFactoryResetModal() {
            document.getElementById('factory-reset-modal').style.display = 'block';
        }
        
        function showResetBatteryModal() {
            document.getElementById('reset-battery-modal').style.display = 'block';
        }
        
        function showSetBatteryCapacityModal() {
            const capacityInput = document.getElementById('battery-capacity');
            const capacity = capacityInput.value;
            
            if (!capacity || capacity < 100 || capacity > 10000) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç”µæ± å®¹é‡ (100-10000 mAh)');
                return;
            }
            
            document.getElementById('capacity-value').textContent = capacity;
            document.getElementById('set-battery-capacity-modal').style.display = 'block';
        }
        
        function hideModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            const statusText = document.getElementById('system-status');
            const statusDot = document.querySelector('.status-dot');
            
            if (connected) {
                statusText.textContent = 'ç³»ç»Ÿè¿è¡Œä¸­';
                statusDot.style.background = 'var(--success-color)';
                statusDot.style.animation = 'pulse 2s infinite';
            } else {
                statusText.textContent = 'è¿æ¥æ–­å¼€';
                statusDot.style.background = 'var(--danger-color)';
                statusDot.style.animation = 'none';
            }
        }
        
        // APIè°ƒç”¨
        async function fetchData() {
            try {
                const response = await fetch('/api/system-info');
                const data = await response.json();
                systemData = data;
                updateUI(data);
                updateConnectionStatus(true);
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                // é™é»˜å¤„ç†é”™è¯¯ï¼Œä¸æ˜¾ç¤ºå¼¹çª—ï¼Œä¿æŒé¡µé¢å¸ƒå±€ä¸å˜
                // å¯ä»¥é€‰æ‹©åœ¨æ§åˆ¶å°è®°å½•é”™è¯¯æˆ–åœ¨çŠ¶æ€æ æ˜¾ç¤ºç¦»çº¿çŠ¶æ€
                updateConnectionStatus(false);
            }
        }
        
        // NTPè®¾ç½®ä¿å­˜
        async function saveNTPSettings() {
            const server = document.getElementById('ntp-server-input').value;
            const autoSync = document.getElementById('ntp-auto-sync').checked;
            const intervalMinutes = parseInt(document.getElementById('ntp-interval-input').value) || 60;
            const intervalSeconds = intervalMinutes * 60; // è½¬æ¢ä¸ºç§’
            
            if (!server.trim()) {
                showAlert('è¯·è¾“å…¥NTPæœåŠ¡å™¨åœ°å€', 'error');
                return;
            }
            
            if (intervalMinutes < 1 || intervalMinutes > 43200) {
                showAlert('æ ¡å‡†é—´éš”å¿…é¡»åœ¨1-43200åˆ†é’Ÿä¹‹é—´', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/ntp-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        server: server,
                        auto_sync: autoSync,
                        interval: intervalSeconds
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('NTPè®¾ç½®å·²ä¿å­˜', 'success');
                    // ç«‹å³åˆ·æ–°æ•°æ®æ˜¾ç¤ºæ›´æ–°åçš„é…ç½®
                    setTimeout(fetchData, 500);
                } else {
                    showAlert('ä¿å­˜å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜NTPè®¾ç½®å¤±è´¥:', error);
                showAlert('ä¿å­˜å¤±è´¥: ç½‘ç»œé”™è¯¯', 'error');
            }
        }
        
        // NTPç«‹å³åŒæ­¥
        async function syncNTP() {
            const syncBtn = event.target;
            const originalText = syncBtn.innerHTML;
            
            syncBtn.innerHTML = 'ğŸ”„ åŒæ­¥ä¸­...';
            syncBtn.disabled = true;
            
            try {
                const response = await fetch('/api/ntp-sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert(result.message, 'success');
                    // åŒæ­¥å®Œæˆåç«‹å³åˆ·æ–°æ˜¾ç¤º
                    setTimeout(fetchData, 1000);
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                console.error('NTPåŒæ­¥å¤±è´¥:', error);
                showAlert('åŒæ­¥å¤±è´¥: ç½‘ç»œé”™è¯¯', 'error');
            }
            
            syncBtn.innerHTML = originalText;
            syncBtn.disabled = false;
        }
        
        function updateUI(data) {
            // æ›´æ–°å”¤é†’æ¨¡å¼ï¼ˆåŒæ­¥æ•°æ®åˆ·æ–°é¢‘ç‡ï¼‰
            if (data.wakeup_mode !== undefined && window.updateWakeupMode) {
                window.updateWakeupMode(data.wakeup_mode);
            }
            
            // æ›´æ–°ç³»ç»ŸçŠ¶æ€ä¸­çš„æ˜¾ç¤ºä¿¡æ¯ï¼ˆä»ç³»ç»Ÿå†…éƒ¨è·å–ï¼‰
            if (data.current_display_content !== undefined) {
                // åˆ›å»ºè‹±æ–‡åˆ°ä¸­æ–‡çš„æ˜ å°„
                const displayContentMap = {
                    'time': 'æ—¶é—´',
                    'bmp580_temperature': 'BMP580æ¸©åº¦',
                    'bmp580_pressure': 'BMP580æ°”å‹',
                    'aht20_temperature': 'AHT20æ¸©åº¦',
                    'aht20_humidity': 'AHT20æ¹¿åº¦',
                    'custom': 'è‡ªå®šä¹‰å†…å®¹'
                };
                
                // ä½¿ç”¨æ˜ å°„è½¬æ¢ä¸ºä¸­æ–‡æ˜¾ç¤ºï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°æ˜ å°„åˆ™ä½¿ç”¨åŸå€¼
                const displayText = displayContentMap[data.current_display_content] || data.current_display_content;
                document.getElementById('current-display-content').textContent = displayText;
            }
            if (data.current_refresh_rate !== undefined) {
                document.getElementById('current-refresh-rate').textContent = data.current_refresh_rate;
            }
            
            // æ›´æ–°æ—¶é—´ä¿¡æ¯ (RTCæ—¶é—´ç”±ç‹¬ç«‹çš„å®šæ—¶å™¨æ›´æ–°)
                            document.getElementById('last-calibration').textContent = data.last_calibration_time || 'ä»æœªæ ¡å‡†';
                document.getElementById('ntp-server').textContent = data.ntp_server || 'ntp.ntsc.ac.cn';
                document.getElementById('runtime').textContent = data.total_runtime || '0000H00M';
                
                // æ›´æ–°RTCæ—¶é—´æ˜¾ç¤º
                if (data.current_rtc_time && data.current_rtc_time !== '--:--:--') {
                    document.getElementById('rtc-time').textContent = data.current_rtc_time;
                }
                
                // æ›´æ–°æ—¶åŒºæ˜¾ç¤º
                if (data.timezone_name && data.timezone_offset_sec !== undefined) {
                    const hours = Math.floor(data.timezone_offset_sec / 3600);
                    const sign = hours >= 0 ? '+' : '';
                    const timezoneText = `${data.timezone_name} (UTC${sign}${hours})`;
                    document.getElementById('timezone').textContent = timezoneText;
                }
            
            // æ›´æ–°ç³»ç»ŸçŠ¶æ€ - ä½¿ç”¨çœŸå®æ•°æ®å¹¶æ·»åŠ é¢œè‰²æŒ‡ç¤º
            const batteryPercent = data.battery_percentage || 0;
            document.getElementById('battery-percent').textContent = batteryPercent + '%';
            const batteryProgress = document.getElementById('battery-progress');
            batteryProgress.style.width = batteryPercent + '%';
            // ç”µé‡é¢œè‰²æŒ‡ç¤º
            if (batteryPercent > 60) {
                batteryProgress.style.backgroundColor = '#4CAF50'; // ç»¿è‰²
            } else if (batteryPercent > 30) {
                batteryProgress.style.backgroundColor = '#FF9800'; // æ©™è‰²
            } else {
                batteryProgress.style.backgroundColor = '#F44336'; // çº¢è‰²
            }
            
            document.getElementById('battery-voltage').textContent = data.battery_voltage + 'mV';
            
            // æ›´æ–°ç”µæ± ç”µæµï¼Œæ˜¾ç¤ºå……ç”µ/æ”¾ç”µçŠ¶æ€
            const batteryCurrent = data.battery_current || 0;
            const currentElement = document.getElementById('battery-current');
            if (batteryCurrent > 0) {
                currentElement.textContent = '+' + batteryCurrent + 'mA (å……ç”µ)';
                currentElement.style.color = '#4CAF50'; // ç»¿è‰²è¡¨ç¤ºå……ç”µ
            } else if (batteryCurrent < 0) {
                currentElement.textContent = batteryCurrent + 'mA (æ”¾ç”µ)';
                currentElement.style.color = '#FF9800'; // æ©™è‰²è¡¨ç¤ºæ”¾ç”µ
            } else {
                currentElement.textContent = '0mA (å¾…æœº)';
                currentElement.style.color = '#666666'; // ç°è‰²è¡¨ç¤ºå¾…æœº
            }
            
            const cpuUsage = data.cpu_usage || 0;
            document.getElementById('cpu-usage').textContent = cpuUsage + '%';
            const cpuProgress = document.getElementById('cpu-progress');
            cpuProgress.style.width = cpuUsage + '%';
            // CPUä½¿ç”¨ç‡é¢œè‰²æŒ‡ç¤º
            if (cpuUsage < 50) {
                cpuProgress.style.backgroundColor = '#4CAF50'; // ç»¿è‰²
            } else if (cpuUsage < 80) {
                cpuProgress.style.backgroundColor = '#FF9800'; // æ©™è‰²
            } else {
                cpuProgress.style.backgroundColor = '#F44336'; // çº¢è‰²
            }
            
            const memoryUsage = data.memory_usage || 0;
            document.getElementById('memory-usage').textContent = memoryUsage + '%';
            const memoryProgress = document.getElementById('memory-progress');
            memoryProgress.style.width = memoryUsage + '%';
            // å†…å­˜ä½¿ç”¨ç‡é¢œè‰²æŒ‡ç¤º
            if (memoryUsage < 70) {
                memoryProgress.style.backgroundColor = '#4CAF50'; // ç»¿è‰²
            } else if (memoryUsage < 90) {
                memoryProgress.style.backgroundColor = '#FF9800'; // æ©™è‰²
            } else {
                memoryProgress.style.backgroundColor = '#F44336'; // çº¢è‰²
            }
            
            const flashUsage = data.flash_usage || 0;
            document.getElementById('flash-usage').textContent = flashUsage + '%';
            const flashProgress = document.getElementById('flash-progress');
            flashProgress.style.width = flashUsage + '%';
            // Flashä½¿ç”¨ç‡é¢œè‰²æŒ‡ç¤º
            if (flashUsage < 80) {
                flashProgress.style.backgroundColor = '#4CAF50'; // ç»¿è‰²
            } else if (flashUsage < 95) {
                flashProgress.style.backgroundColor = '#FF9800'; // æ©™è‰²
            } else {
                flashProgress.style.backgroundColor = '#F44336'; // çº¢è‰²
            }
            
            // æ›´æ–°ä¼ æ„Ÿå™¨æ•°æ®
            document.getElementById('bmp580-temperature').textContent = data.bmp580_temperature ? data.bmp580_temperature.toFixed(1) + 'Â°C' : '--';
            document.getElementById('bmp580-pressure').textContent = data.bmp580_pressure ? data.bmp580_pressure.toFixed(1) + 'hPa' : '--';
            document.getElementById('aht20-temperature').textContent = data.aht20_temperature ? data.aht20_temperature.toFixed(1) + 'Â°C' : '--';
            document.getElementById('aht20-humidity').textContent = data.aht20_humidity ? data.aht20_humidity.toFixed(1) + '%' : '--';
            
            // æ›´æ–°ç½‘ç»œä¿¡æ¯
            document.getElementById('ap-ssid').textContent = data.ap_ssid || 'NixieClock';
            document.getElementById('ap-ip').textContent = data.ap_ip_address || '192.168.4.1';
            document.getElementById('ap-gateway').textContent = data.ap_gateway || '192.168.4.1';
            document.getElementById('wifi-ssid').textContent = data.sta_connected ? data.sta_ssid : 'æœªè¿æ¥';
            document.getElementById('sta-ip').textContent = data.sta_ip_address || '--';
            
            // ä»…åœ¨åˆå§‹åŠ è½½æ—¶æ›´æ–°è¡¨å•é»˜è®¤å€¼
            if (isInitialLoad) {
                document.getElementById('wifi-enable').checked = data.wifi_enabled !== false;
                document.getElementById('ap-enable').checked = data.ap_enabled !== false;
                
                // åŠ è½½APé…ç½®çš„æ‰€æœ‰ä¿¡æ¯
                document.getElementById('ap-ssid-input').value = data.ap_ssid || 'NixieClock';
                document.getElementById('ap-password-input').value = data.ap_password || '12345678';
                document.getElementById('ap-ip-input').value = data.ap_ip_address || '192.168.4.1';
                document.getElementById('ap-gateway-input').value = data.ap_gateway || '192.168.4.1';
                
                // å¦‚æœæœ‰ä¿å­˜çš„WiFié…ç½®ï¼Œä¹ŸåŠ è½½åˆ°è¾“å…¥æ¡†ï¼ˆä»…SSIDï¼Œå¯†ç ä¸ºç©ºï¼‰
                if (data.sta_ssid && data.sta_ssid !== 'æœªè¿æ¥') {
                    document.getElementById('wifi-ssid-input').value = data.sta_ssid;
                    // å¯†ç ç•™ç©ºï¼Œç”¨æˆ·éœ€è¦é‡æ–°è¾“å…¥
                    document.getElementById('wifi-password-input').value = '';
                }
                
                document.getElementById('ntp-server-input').value = data.ntp_server || 'ntp.ntsc.ac.cn';
                document.getElementById('ntp-auto-sync').checked = data.ntp_auto_sync !== false;
                // å°†ç§’è½¬æ¢ä¸ºåˆ†é’Ÿæ˜¾ç¤º
                const intervalMinutes = data.ntp_sync_interval ? Math.round(data.ntp_sync_interval / 60) : 60;
                document.getElementById('ntp-interval-input').value = intervalMinutes;
                
                // è®¾ç½®æ—¶åŒºé€‰æ‹©
                const timezoneSelect = document.getElementById('timezone-select');
                if (timezoneSelect && data.timezone_offset_sec !== undefined) {
                    timezoneSelect.value = data.timezone_offset_sec.toString();
                }
                
                // è®¾ç½®å½“å‰æ—¶é—´åˆ°æ‰‹åŠ¨æ—¶é—´è¾“å…¥æ¡†ï¼ˆä»…åœ¨åˆå§‹åŠ è½½æ—¶ï¼‰
                const now = new Date();
                const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('manual-time-input').value = localDateTime;
                
                // æ§åˆ¶æ˜¾ç¤ºçŠ¶æ€
                const wifiContent = document.getElementById('wifi-config-content');
                const apContent = document.getElementById('ap-config-content');
                const intervalGroup = document.getElementById('ntp-interval-group');
                
                wifiContent.style.display = document.getElementById('wifi-enable').checked ? 'block' : 'none';
                apContent.style.display = document.getElementById('ap-enable').checked ? 'block' : 'none';
                intervalGroup.style.display = document.getElementById('ntp-auto-sync').checked ? 'block' : 'none';
                
                // æ ‡è®°åˆå§‹åŠ è½½å®Œæˆ
                isInitialLoad = false;
            }
        }
        
        // WiFiç½‘ç»œæ‰«æ
        async function scanWifiNetworks() {
            const scanBtn = document.getElementById('scan-btn');
            const originalText = scanBtn.innerHTML;
            
            scanBtn.innerHTML = 'ğŸ”„ æ‰«æä¸­...';
            scanBtn.disabled = true;
            
            try {
                const response = await fetch('/api/wifi/scan');
                const data = await response.json();
                
                if (data.success && data.networks) {
                    displayWifiNetworks(data.networks);
                    showToast(`å‘ç° ${data.networks.length} ä¸ªç½‘ç»œ`, 'info');
                } else {
                    showAlert('æ‰«æå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                    // æ˜¾ç¤ºç©ºåˆ—è¡¨
                    document.getElementById('network-list').innerHTML = 
                        '<div style="text-align: center; padding: 20px; color: #666;">æ‰«æå¤±è´¥ï¼Œè¯·é‡è¯•</div>';
                }
            } catch (error) {
                console.error('æ‰«æç½‘ç»œå¤±è´¥:', error);
                showAlert('æ‰«æå¤±è´¥: ç½‘ç»œè¿æ¥é”™è¯¯', 'error');
                document.getElementById('network-list').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #666;">ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥</div>';
            }
            
            scanBtn.innerHTML = originalText;
            scanBtn.disabled = false;
        }
        
        // æ˜¾ç¤ºWiFiç½‘ç»œåˆ—è¡¨
        function displayWifiNetworks(networks) {
            const networkList = document.getElementById('network-list');
            
            if (!networks || networks.length === 0) {
                networkList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">æœªæ‰¾åˆ°ç½‘ç»œ</div>';
                return;
            }
            
            // æŒ‰ä¿¡å·å¼ºåº¦æ’åº
            networks.sort((a, b) => b.rssi - a.rssi);
            
            networkList.innerHTML = '';
            networks.forEach(network => {
                const networkItem = document.createElement('div');
                networkItem.className = 'network-item';
                networkItem.onclick = () => selectNetwork(network.ssid, networkItem);
                
                const signalBars = createSignalBars(network.rssi);
                const securityIcon = network.security === 'Open' ? 'ğŸ”“' : 'ğŸ”’';
                
                networkItem.innerHTML = `
                    <div>
                        <div class="network-ssid">${network.ssid}</div>
                        <div class="network-info">
                            <span class="security-icon">${securityIcon}</span>
                            <span>${network.security}</span>
                            <span>ä¿¡é“ ${network.channel}</span>
                        </div>
                    </div>
                    <div class="signal-strength">
                        ${signalBars}
                        <span style="margin-left: 5px; font-size: 11px;">${network.rssi}dBm</span>
                    </div>
                `;
                
                networkList.appendChild(networkItem);
            });
        }
        
        // åˆ›å»ºä¿¡å·å¼ºåº¦æŒ‡ç¤ºæ¡
        function createSignalBars(rssi) {
            const bars = [];
            const strength = getSignalStrength(rssi);
            
            for (let i = 0; i < 4; i++) {
                const height = 4 + i * 3;
                const active = i < strength ? 'active' : '';
                bars.push(`<div class="signal-bar ${active}" style="height: ${height}px;"></div>`);
            }
            
            return bars.join('');
        }
        
        // æ ¹æ®RSSIè®¡ç®—ä¿¡å·å¼ºåº¦ç­‰çº§
        function getSignalStrength(rssi) {
            if (rssi >= -50) return 4;
            if (rssi >= -60) return 3;
            if (rssi >= -70) return 2;
            if (rssi >= -80) return 1;
            return 0;
        }
        
        // é€‰æ‹©ç½‘ç»œ
        function selectNetwork(ssid, element) {
            // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.network-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            element.classList.add('selected');
            
            // å¡«å……åˆ°è¾“å…¥æ¡†
            document.getElementById('wifi-ssid-input').value = ssid;
        }
        
        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('wifi-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const enabled = document.getElementById('wifi-enable').checked;
            const ssid = document.getElementById('wifi-ssid-input').value;
            const password = document.getElementById('wifi-password-input').value;
            
            if (enabled && !ssid) {
                showAlert('è¯·è¾“å…¥WiFiåç§°', 'error');
                return;
            }
            
            // æ˜¾ç¤ºè¿æ¥è¿›åº¦
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = enabled ? 'ğŸ”„ è¿æ¥ä¸­...' : 'ğŸ”„ æ–­å¼€ä¸­...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch('/api/wifi-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        enabled: enabled,
                        ssid: ssid, 
                        password: password 
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    // è¿æ¥æˆåŠŸååˆ·æ–°ç½‘ç»œçŠ¶æ€
                    setTimeout(fetchData, 2000);
                } else {
                    showAlert(result.message || 'WiFié…ç½®å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('WiFié…ç½®å¤±è´¥:', error);
                showAlert('WiFié…ç½®å¤±è´¥: ç½‘ç»œé”™è¯¯', 'error');
            }
            
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
        
        document.getElementById('ap-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const enabled = document.getElementById('ap-enable').checked;
            const ssid = document.getElementById('ap-ssid-input').value;
            const password = document.getElementById('ap-password-input').value;
            const ip = document.getElementById('ap-ip-input').value;
            const gateway = document.getElementById('ap-gateway-input').value;
            
            if (enabled && !ssid) {
                showAlert('è¯·è¾“å…¥APåç§°', 'error');
                return;
            }
            
            if (enabled && password && password.length < 8) {
                showAlert('APå¯†ç è‡³å°‘éœ€è¦8ä½', 'error');
                return;
            }
            
            // éªŒè¯IPåœ°å€æ ¼å¼
            const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (enabled && !ipPattern.test(ip)) {
                showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„IPåœ°å€', 'error');
                return;
            }
            
            if (enabled && !ipPattern.test(gateway)) {
                showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å…³åœ°å€', 'error');
                return;
            }
            
            // æ˜¾ç¤ºé…ç½®è¿›åº¦
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = enabled ? 'ğŸ”„ å¯åŠ¨ä¸­...' : 'ğŸ”„ å…³é—­ä¸­...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch('/api/ap-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        enabled: enabled,
                        ssid: ssid, 
                        password: password,
                        ip: ip,
                        gateway: gateway
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    // APé…ç½®æˆåŠŸååˆ·æ–°ç½‘ç»œçŠ¶æ€
                    setTimeout(fetchData, 1000);
                } else {
                    showAlert(result.message || 'APé…ç½®å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('APé…ç½®å¤±è´¥:', error);
                showAlert('APé…ç½®å¤±è´¥: ç½‘ç»œé”™è¯¯', 'error');
            }
            
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
        
        // WiFiå’ŒAPå¼€å…³æ§åˆ¶
        document.getElementById('wifi-enable').addEventListener('change', async function() {
            const wifiContent = document.getElementById('wifi-config-content');
            wifiContent.style.display = this.checked ? 'block' : 'none';
            
            // ç«‹å³æäº¤é…ç½®æ›´æ”¹
            const enabled = this.checked;
            if (!enabled) {
                // å¦‚æœç¦ç”¨WiFiï¼Œç«‹å³æ–­å¼€è¿æ¥
                if (confirm('ç¡®å®šè¦æ–­å¼€WiFiè¿æ¥å—ï¼Ÿ')) {
                    await submitWifiConfig(false, '', '');
                } else {
                    // å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œæ¢å¤å¼€å…³çŠ¶æ€
                    this.checked = true;
                    wifiContent.style.display = 'block';
                }
            }
        });
        
        document.getElementById('ap-enable').addEventListener('change', async function() {
            const apContent = document.getElementById('ap-config-content');
            apContent.style.display = this.checked ? 'block' : 'none';
            
            // ç«‹å³æäº¤é…ç½®æ›´æ”¹
            const enabled = this.checked;
            if (!enabled) {
                // å¦‚æœç¦ç”¨APï¼Œç«‹å³å…³é—­çƒ­ç‚¹
                const wifiConnected = systemData && systemData.sta_connected;
                let confirmMessage = 'ç¡®å®šè¦å…³é—­APçƒ­ç‚¹å—ï¼Ÿ\n\nâš ï¸ è­¦å‘Šï¼š';
                
                if (wifiConnected) {
                    confirmMessage += 'å…³é—­APåï¼Œé¡µé¢å°†é€šè¿‡WiFiè¿æ¥ç»§ç»­è®¿é—®ã€‚\nå¦‚æœWiFiè¿æ¥ä¸ç¨³å®šï¼Œå¯èƒ½éœ€è¦é‡æ–°è¿æ¥è®¾å¤‡ã€‚';
                } else {
                    confirmMessage += 'å…³é—­APåï¼Œç”±äºWiFiæœªè¿æ¥ï¼Œæ‚¨å°†æ— æ³•ç»§ç»­è®¿é—®æ­¤é¡µé¢ï¼\nå»ºè®®å…ˆè¿æ¥WiFiå†å…³é—­APã€‚';
                }
                
                if (confirm(confirmMessage)) {
                    const success = await submitApConfig(false, '', '', '', '');
                    if (!success && !wifiConnected) {
                        // å¦‚æœå…³é—­å¤±è´¥ä¸”æ²¡æœ‰WiFiè¿æ¥ï¼Œæ¢å¤å¼€å…³çŠ¶æ€
                        this.checked = true;
                        apContent.style.display = 'block';
                    }
                } else {
                    // å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œæ¢å¤å¼€å…³çŠ¶æ€
                    this.checked = true;
                    apContent.style.display = 'block';
                }
            }
        });
        
        // NTPè‡ªåŠ¨æ ¡å‡†æ§åˆ¶
        document.getElementById('ntp-auto-sync').addEventListener('change', function() {
            const intervalGroup = document.getElementById('ntp-interval-group');
            intervalGroup.style.display = this.checked ? 'block' : 'none';
        });
        
        // ç‹¬ç«‹çš„WiFié…ç½®æäº¤å‡½æ•°
        async function submitWifiConfig(enabled, ssid, password) {
            try {
                const response = await fetch('/api/wifi-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        enabled: enabled,
                        ssid: ssid, 
                        password: password 
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    // è¿æ¥æˆåŠŸååˆ·æ–°ç½‘ç»œçŠ¶æ€
                    setTimeout(fetchData, 2000);
                } else {
                    showAlert(result.message || 'WiFié…ç½®å¤±è´¥', 'error');
                }
                return result.success;
            } catch (error) {
                console.error('WiFié…ç½®å¤±è´¥:', error);
                showAlert('WiFié…ç½®å¤±è´¥: ç½‘ç»œé”™è¯¯', 'error');
                return false;
            }
        }
        
        // ç‹¬ç«‹çš„APé…ç½®æäº¤å‡½æ•°
        async function submitApConfig(enabled, ssid, password, ip, gateway) {
            try {
                const response = await fetch('/api/ap-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        enabled: enabled,
                        ssid: ssid, 
                        password: password,
                        ip: ip,
                        gateway: gateway
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    // APé…ç½®æˆåŠŸååˆ·æ–°ç½‘ç»œçŠ¶æ€
                    setTimeout(fetchData, 1000);
                } else {
                    showAlert(result.message || 'APé…ç½®å¤±è´¥', 'error');
                }
                return result.success;
            } catch (error) {
                console.error('APé…ç½®å¤±è´¥:', error);
                showAlert('APé…ç½®å¤±è´¥: ç½‘ç»œé”™è¯¯', 'error');
                return false;
            }
        }
        
        // NTPé—´éš”è¾“å…¥éªŒè¯
        document.getElementById('ntp-interval-input').addEventListener('input', function() {
            const value = parseInt(this.value);
            const isValid = value >= 1 && value <= 1440;
            
            if (this.value && !isValid) {
                this.style.borderColor = 'var(--danger-color)';
            } else {
                this.style.borderColor = 'var(--border-color)';
            }
        });
        
        // ä¿å­˜NTPè®¾ç½®
        async function saveNTPSettings() {
            const server = document.getElementById('ntp-server-input').value;
            const autoSync = document.getElementById('ntp-auto-sync').checked;
            const intervalMinutes = document.getElementById('ntp-interval-input').value;
            
            if (!server) {
                showAlert('è¯·è¾“å…¥NTPæœåŠ¡å™¨åœ°å€', 'error');
                return;
            }
            
            if (autoSync && (!intervalMinutes || intervalMinutes < 1 || intervalMinutes > 1440)) {
                showAlert('æ ¡å‡†é—´éš”å¿…é¡»åœ¨1-1440åˆ†é’Ÿä¹‹é—´', 'error');
                return;
            }
            
            // å°†åˆ†é’Ÿè½¬æ¢ä¸ºç§’
            const intervalSeconds = autoSync ? parseInt(intervalMinutes) * 60 : 0;
            
            try {
                const response = await fetch('/api/ntp-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        server: server,
                        auto_sync: autoSync,
                        interval: intervalSeconds,
                        interval_minutes: parseInt(intervalMinutes)
                    })
                });
                const result = await response.json();
                showAlert(result.message || 'NTPè®¾ç½®å·²ä¿å­˜', 'success');
            } catch (error) {
                showToast('NTPè®¾ç½®ä¿å­˜å¤±è´¥', 'error');
            }
        }
        
        async function syncNTP() {
            const server = document.getElementById('ntp-server-input').value;
            
            if (!server) {
                showAlert('è¯·è¾“å…¥NTPæœåŠ¡å™¨åœ°å€', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/ntp-sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ server: server })
                });
                const result = await response.json();
                showAlert(result.message || 'NTPæ—¶é—´åŒæ­¥å·²å¯åŠ¨', 'success');
            } catch (error) {
                showToast('NTPåŒæ­¥å¤±è´¥', 'error');
            }
        }
        
        async function setManualTime() {
            const datetime = document.getElementById('manual-time-input').value;
            if (!datetime) {
                showAlert('è¯·é€‰æ‹©æ—¶é—´', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/manual-time', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ datetime })
                });
                const result = await response.json();
                showAlert(result.message || 'æ—¶é—´è®¾ç½®æˆåŠŸ', 'success');
            } catch (error) {
                showToast('æ—¶é—´è®¾ç½®å¤±è´¥', 'error');
            }
        }
        
        // æ›´æ–°æ—¶åŒºåç§»æ˜¾ç¤º
        function updateTimezoneOffset() {
            const timezoneSelect = document.getElementById('timezone-select');
            const selectedOption = timezoneSelect.options[timezoneSelect.selectedIndex];
            const offset = parseInt(timezoneSelect.value);
            const hours = Math.floor(offset / 3600);
            const sign = hours >= 0 ? '+' : '';
            console.log(`é€‰æ‹©çš„æ—¶åŒº: ${selectedOption.text} (åç§»: ${sign}${hours}å°æ—¶)`);
        }
        
        // ä¿å­˜æ—¶åŒºè®¾ç½®
        async function saveTimezoneSettings() {
            const timezoneSelect = document.getElementById('timezone-select');
            const selectedOption = timezoneSelect.options[timezoneSelect.selectedIndex];
            const offset = parseInt(timezoneSelect.value);
            const timezoneName = selectedOption.getAttribute('data-name');
            
            try {
                const response = await fetch('/api/timezone-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        timezone_name: timezoneName,
                        timezone_offset: offset
                    })
                });
                const result = await response.json();
                showAlert(result.message || 'æ—¶åŒºè®¾ç½®å·²ä¿å­˜', 'success');
                // åˆ·æ–°æ•°æ®ä»¥æ›´æ–°æ—¶åŒºæ˜¾ç¤º
                setTimeout(fetchData, 1000);
            } catch (error) {
                showToast('æ—¶åŒºè®¾ç½®ä¿å­˜å¤±è´¥', 'error');
            }
        }
        
        // ä½¿ç”¨æµè§ˆå™¨æ—¶é—´æ ¡å‡†
        function setBrowserTime() {
            const now = new Date();
            // è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´æ ¼å¼ï¼Œé€‚é…datetime-localè¾“å…¥æ¡†
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            
            // å¡«å……åˆ°è¾“å…¥æ¡†
            document.getElementById('manual-time-input').value = localDateTime;
            
            // è‡ªåŠ¨æäº¤è®¾ç½®
            if (confirm('ç¡®å®šè¦ä½¿ç”¨å½“å‰æµè§ˆå™¨æ—¶é—´ (' + now.toLocaleString() + ') æ ¡å‡†è®¾å¤‡æ—¶é—´å—ï¼Ÿ')) {
                setManualTime();
            }
        }
        
        async function confirmReboot() {
            hideModal('reboot-modal');
            
            try {
                const response = await fetch('/api/reboot', {
                    method: 'POST'
                });
                const result = await response.json();
                showAlert(result.message || 'ç³»ç»Ÿæ­£åœ¨é‡å¯...', 'success');
            } catch (error) {
                showToast('é‡å¯å¤±è´¥', 'error');
            }
        }
        
        async function confirmFactoryReset() {
            hideModal('factory-reset-modal');
            
            try {
                const response = await fetch('/api/factory-reset', {
                    method: 'POST'
                });
                const result = await response.json();
                showAlert(result.message || 'æ­£åœ¨æ¢å¤å‡ºå‚è®¾ç½®...', 'success');
            } catch (error) {
                showToast('æ¢å¤å‡ºå‚è®¾ç½®å¤±è´¥', 'error');
            }
        }
        
        async function confirmResetBattery() {
            hideModal('reset-battery-modal');
            
            try {
                const response = await fetch('/api/reset-battery', {
                    method: 'POST'
                });
                const result = await response.json();
                showToast(result.message || 'ç”µé‡è®¡å¤ä½æˆåŠŸ', 'success');
            } catch (error) {
                showToast('ç”µé‡è®¡å¤ä½å¤±è´¥', 'error');
            }
        }
        
        async function confirmSetBatteryCapacity() {
            hideModal('set-battery-capacity-modal');
            const capacity = document.getElementById('battery-capacity').value;
            
            try {
                const response = await fetch('/api/set-battery-capacity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ capacity: parseInt(capacity) })
                });
                const result = await response.json();
                showToast(result.message || 'ç”µæ± å®¹é‡è®¾ç½®æˆåŠŸ', 'success');
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('battery-capacity').value = '';
            } catch (error) {
                showToast('ç”µæ± å®¹é‡è®¾ç½®å¤±è´¥', 'error');
            }
        }
        
        // å¯åŠ¨RTCæ—¶é—´åŒæ­¥æ›´æ–°
        startSyncedTimeUpdate();
        
        // å¯åŠ¨ä¸æ—¶é—´åŒæ­¥çš„æ•°æ®åˆ·æ–°
        startSyncedDataUpdate();
        
        // åˆå§‹åŠ è½½
        fetchData();
        
        // åˆå§‹åŒ–æ˜¾ç¤ºå†…å®¹é€‰æ‹©
        updateDisplayContent();
        document.getElementById('display-content-select').addEventListener('change', updateDisplayContent);
        
        // åˆå§‹åŒ–åˆ·æ–°ç‡é€‰æ‹©
        updateRefreshRate();
        document.getElementById('refresh-rate-select').addEventListener('change', updateRefreshRate);
        
        // æ˜¾ç¤ºå†…å®¹é€‰æ‹©ç›¸å…³å‡½æ•°
        function updateDisplayContent() {
            const select = document.getElementById('display-content-select');
            const customGroup = document.getElementById('custom-content-group');
            
            if (select.value === 'custom') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
            }
        }
        
        // åˆ·æ–°ç‡é€‰æ‹©å‡½æ•°
        function updateRefreshRate() {
            const select = document.getElementById('refresh-rate-select');
            const currentRefreshRate = document.getElementById('current-refresh-rate');
            
            const refreshRateNames = {
                'minute': 'åˆ†è·³å˜ (1æ¬¡/åˆ†é’Ÿ)',
                '1': '1Hz (1æ¬¡/ç§’)',
                '2': '2Hz (2æ¬¡/ç§’)',
                '5': '5Hz (5æ¬¡/ç§’)',
                '10': '10Hz (10æ¬¡/ç§’)'
            };
            
            currentRefreshRate.textContent = refreshRateNames[select.value] || select.value;
            
            // æ›´æ–°æ•°æ®åˆ·æ–°æœºåˆ¶
            if (window.updateDataRefreshRate) {
                window.updateDataRefreshRate(select.value);
            }
        }
        
        async function applyDisplayContent() {
            const select = document.getElementById('display-content-select');
            const customInput = document.getElementById('custom-content-input');
            const currentDisplay = document.getElementById('current-display-content');
            const refreshRateSelect = document.getElementById('refresh-rate-select');
            
            let displayType = select.value;
            let customContent = '';
            
            if (displayType === 'custom') {
                customContent = customInput.value.trim();
                if (!customContent) {
                    showAlert('è¯·è¾“å…¥è‡ªå®šä¹‰æ˜¾ç¤ºå†…å®¹', 'error');
                    return;
                }
                if (customContent.length > 8) {
                    showAlert('è‡ªå®šä¹‰å†…å®¹ä¸èƒ½è¶…è¿‡8ä¸ªå­—ç¬¦', 'error');
                    return;
                }
            }
            
            try {
                // åº”ç”¨æ˜¾ç¤ºå†…å®¹è®¾ç½®
                const displayResponse = await fetch('/api/display-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        display_type: displayType,
                        custom_content: customContent
                    })
                });
                const displayResult = await displayResponse.json();
                
                // åº”ç”¨åˆ·æ–°ç‡è®¾ç½®
                const refreshRateResponse = await fetch('/api/refresh-rate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        refresh_rate: refreshRateSelect.value
                    })
                });
                const refreshRateResult = await refreshRateResponse.json();
                
                if (displayResult.success && refreshRateResult.success) {
                    showAlert('æ˜¾ç¤ºè®¾ç½®å’Œåˆ·æ–°ç‡è®¾ç½®å·²åº”ç”¨', 'success');
                    // æ›´æ–°å½“å‰æ˜¾ç¤ºçŠ¶æ€
                    const displayNames = {
                        'time': 'æ—¶é—´',
                        'bmp580_temperature': 'BMP580æ¸©åº¦',
                        'bmp580_pressure': 'BMP580æ°”å‹',
                        'aht20_temperature': 'AHT20æ¸©åº¦',
                        'aht20_humidity': 'AHT20æ¹¿åº¦',
                        'custom': customContent
                    };
                    currentDisplay.textContent = displayNames[displayType] || displayType;
                    
                    // ç«‹å³åˆ·æ–°ä¸€æ¬¡æ•°æ®
                    if (typeof fetchData === 'function') {
                        fetchData();
                    }
                } else {
                    let errorMsg = '';
                    if (!displayResult.success) {
                        errorMsg += 'æ˜¾ç¤ºè®¾ç½®å¤±è´¥: ' + (displayResult.message || 'æœªçŸ¥é”™è¯¯');
                    }
                    if (!refreshRateResult.success) {
                        if (errorMsg) errorMsg += '; ';
                        errorMsg += 'åˆ·æ–°ç‡è®¾ç½®å¤±è´¥: ' + (refreshRateResult.message || 'æœªçŸ¥é”™è¯¯');
                    }
                    showAlert(errorMsg, 'error');
                }
            } catch (error) {
                console.error('è®¾ç½®å¤±è´¥:', error);
                showAlert('è®¾ç½®å¤±è´¥: ç½‘ç»œé”™è¯¯', 'error');
            }
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>